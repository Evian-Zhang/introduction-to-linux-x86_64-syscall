<!DOCTYPE HTML>
<html lang="zh-Hans" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>mmap, munmap, mremap, msync, remap_file_pages - Linux x86_64系统调用简介</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">序</a></li><li class="chapter-item expanded affix "><a href="../../src/introduction.html">基础知识</a></li><li class="chapter-item expanded affix "><li class="part-title">文件系统</li><li class="chapter-item expanded "><a href="../../src/filesystem/open-openat-name_to_handle_at-open_by_handle_at-open_tree.html"><strong aria-hidden="true">1.</strong> open, openat, name_to_handle_at, open_by_handle_at, open_tree</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/close.html"><strong aria-hidden="true">2.</strong> close</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/read-pread64-readv-preadv-preadv2.html"><strong aria-hidden="true">3.</strong> read, pread64, readv, preadv, preadv2</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/write-pwrite64-writev-pwritev-pwritev2.html"><strong aria-hidden="true">4.</strong> write, pwrite64, writev, pwritev, pwritev2</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/lseek.html"><strong aria-hidden="true">5.</strong> lseek</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/poll-select-pselect6-ppoll.html"><strong aria-hidden="true">6.</strong> poll, select, pselect6, ppoll</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/epoll_create-epoll_wait-epoll_ctl-epoll_pwait-epoll_create1.html"><strong aria-hidden="true">7.</strong> epoll_create, epoll_wait, epoll_ctl, epoll_pwait, epoll_create1</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/stat-fstat-lstat-newfstatat-statx.html"><strong aria-hidden="true">8.</strong> stat, fstat, lstat, newfstatat, statx</a></li><li class="chapter-item expanded "><a href="../../src/filesystem/eventfd-eventfd2.html"><strong aria-hidden="true">9.</strong> eventfd, eventfd2</a></li><li class="chapter-item expanded affix "><li class="part-title">内存管理</li><li class="chapter-item expanded "><a href="../../src/memory_management/mmap-munmap-mremap-msync-remap_file_pages.html" class="active"><strong aria-hidden="true">10.</strong> mmap, munmap, mremap, msync, remap_file_pages</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Linux x86_64系统调用简介</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mmap-munmap-mremap-msync-remap_file_pages系统调用"><a class="header" href="#mmap-munmap-mremap-msync-remap_file_pages系统调用"><code>mmap</code>, <code>munmap</code>, <code>mremap</code>, <code>msync</code>, <code>remap_file_pages</code>系统调用</a></h1>
<h2 id="mmap"><a class="header" href="#mmap"><code>mmap</code></a></h2>
<h3 id="系统调用号"><a class="header" href="#系统调用号">系统调用号</a></h3>
<p>9</p>
<h3 id="函数签名"><a class="header" href="#函数签名">函数签名</a></h3>
<h4 id="内核接口"><a class="header" href="#内核接口">内核接口</a></h4>
<pre><code class="language-c">asmlinkage long sys_mmap(unsigned long addr, unsigned long len, unsigned long prot, unsigned long flags, unsigned long fd, off_t pgoff);
</code></pre>
<h4 id="glibc封装"><a class="header" href="#glibc封装">glibc封装</a></h4>
<pre><code class="language-c">#include &lt;sys/mman.h&gt;
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
</code></pre>
<h3 id="简介"><a class="header" href="#简介">简介</a></h3>
<p><code>mmap</code>做了一个特别神奇的事：把硬盘上的文件与内存之间建立映射。首先，我们来看看最终效果。假设我们有一个二进制文件<code>data.bin</code>，其内容为（16进制）：</p>
<pre><code class="language-plaintext">11 45 14 19 19 81 00
</code></pre>
<p>我们通过<code>mmap</code>，将这个文件映射到了内存中从<code>0x10000</code>开始的区域。接下来，如果我们的程序从内存<code>0x10002</code>读取2字节的内容，将得到<code>0x1914</code>这个数字（小端序）。</p>
<p>也就是说，我们没有借助<code>read</code>系统调用，而是直接对某个内存区域进行读取，就能读取到硬盘上的文件的内容。</p>
<p>接着我们来看看其参数。</p>
<p>总得来说，<code>mmap</code>的行为是，在<code>flags</code>的控制下，将描述符为<code>fd</code>的文件中，从<code>offset</code>位置开始，<code>length</code>个字节映射到地址为<code>addr</code>的内存空间中，并设置其内存保护为<code>prot</code>。</p>
<p>在一般情况下，地址和长度应遵守这样的限制：</p>
<ul>
<li>如果<code>addr</code>为<code>NULL</code>，则内核自己选择适当的内存地址进行映射。如果其不为<code>NULL</code>，则内核以<code>addr</code>的值为参考，选择一个适当的内存地址进行映射（一般是之后最近的页边界）。</li>
<li><code>offset</code>应为页大小的倍数。</li>
<li><code>length</code>应大于0。如果被映射的大小不是页大小的整数倍，则剩下的页的部分会被0填充。</li>
</ul>
<p>控制<code>mmap</code>行为的核心为<code>flags</code>。其可以包含以下标志位：</p>
<ul>
<li>
<p>核心标志位</p>
<p>以下三个标志位必须且只能包含一个。</p>
<ul>
<li>
<p><code>MAP_SHARED</code></p>
<p>建立一个共享的映射。</p>
<p>如果在该进程中，对该映射后的内存区域进行修改，那么在别的进程中，如果其使用了<code>mmap</code>，将同一个文件也进行了映射，那么可以同步看见该修改。同时被映射的文件也会被修改。</p>
</li>
<li>
<p><code>MAP_SHARED_VALIDATE</code></p>
<p>行为和<code>MAP_SHARED</code>类似。但是会核验<code>flags</code>，如果其包含了未知的标志位，将报错<code>EOPNOTSUPP</code>。</p>
</li>
<li>
<p><code>MAP_PRIVATE</code></p>
<p>建立一个私有的写时复制（copy-on-write）的映射。</p>
<p>对该映射的内存区域进行的修改不会同步到其他进程中，也不会修改硬盘里相应的文件。</p>
</li>
</ul>
</li>
<li>
<p>附加标志位</p>
<p>除了三个必要的标志位之外，还有一些标志位也可以被包含。其主要包括</p>
<ul>
<li>
<p><code>MAP_ANONYMOUS</code></p>
<p>忽略<code>fd</code>，被映射的内存区域将被初始化为0。</p>
<p>此时<code>fd</code>应为-1，<code>offset</code>应为0。</p>
</li>
<li>
<p><code>MAP_FIXED</code></p>
<p>将<code>addr</code>看作确切的地址，而非一个参考。</p>
<p>内核将准确地将文件映射到从<code>addr</code>开始的内存区域。如果这个映射与之前已经存在的内存映射有重合，则重合的部分将被新的映射覆盖。</p>
</li>
<li>
<p><code>MAP_FIXED_NOREPLACE</code></p>
<p>行为和<code>MAP_FIXED</code>类似，但不会覆盖已有的内存映射。如果与已有的内存映射有重合，那么将直接返回错误<code>EEXIST</code>。</p>
</li>
</ul>
</li>
</ul>
<p><code>prot</code>参数则是控制映射的内存区域的内存保护，其可能的值包括</p>
<ul>
<li>
<p><code>PROC_EXEC</code></p>
<p>页可执行</p>
</li>
<li>
<p><code>PROC_READ</code></p>
<p>页可读</p>
</li>
<li>
<p><code>PROC_WRITE</code></p>
<p>页可写</p>
</li>
<li>
<p><code>PROC_NONE</code></p>
<p>页不可访问</p>
</li>
</ul>
<p>使用<code>mmap</code>读取文件的好处在于：使用<code>read</code>读取文件时，会先将文件的内容从硬盘上复制到内核的内存空间中，然后再由内核将数据复制到用户的内存空间中。但使用<code>mmap</code>时，文件的内容是可以直接复制到用户的内存空间中的。</p>
<h3 id="实现"><a class="header" href="#实现">实现</a></h3>
<p><code>mmap</code>的实现位于Linux内核源码的<code>arch/x86/kernel/sys_x86_64.c</code>，其直接调用了位于<code>mm/mmap.c</code>的<code>ksys_mmap_pgoff</code>函数。在经过了复杂的函数链之后，我们可以发现，其最终是调用的位于<code>include/linux/fs.h</code>的<code>call_mmap</code>函数：</p>
<pre><code class="language-c">static inline int call_mmap(struct file *file, struct vm_area_struct *vma)
{
	return file-&gt;f_op-&gt;mmap(file, vma);
}
</code></pre>
<p>其中<code>struct vm_area_struct</code>这个结构体，表示一块虚拟内存，其包含一个类型为<code>struct vm_operations_struct</code>的字段<code>vm_ops</code>，表示对虚拟内存的操作，其定义在<code>include/linux/mm.h</code>:</p>
<pre><code class="language-c">/*
 * These are the virtual MM functions - opening of an area, closing and
 * unmapping it (needed to keep files on disk up-to-date etc), pointer
 * to the functions called when a no-page or a wp-page exception occurs.
 */
struct vm_operations_struct {
	void (*open)(struct vm_area_struct * area);
	void (*close)(struct vm_area_struct * area);
	int (*split)(struct vm_area_struct * area, unsigned long addr);
	int (*mremap)(struct vm_area_struct * area);
	vm_fault_t (*fault)(struct vm_fault *vmf);
	vm_fault_t (*huge_fault)(struct vm_fault *vmf,
			enum page_entry_size pe_size);
	void (*map_pages)(struct vm_fault *vmf,
			pgoff_t start_pgoff, pgoff_t end_pgoff);
	unsigned long (*pagesize)(struct vm_area_struct * area);

	/* notification that a previously read-only page is about to become
	 * writable, if an error is returned it will cause a SIGBUS */
	vm_fault_t (*page_mkwrite)(struct vm_fault *vmf);

	/* same as page_mkwrite when using VM_PFNMAP|VM_MIXEDMAP */
	vm_fault_t (*pfn_mkwrite)(struct vm_fault *vmf);

	/* called by access_process_vm when get_user_pages() fails, typically
	 * for use by special VMAs that can switch between memory and hardware
	 */
	int (*access)(struct vm_area_struct *vma, unsigned long addr,
		      void *buf, int len, int write);

	/* Called by the /proc/PID/maps code to ask the vma whether it
	 * has a special name.  Returning non-NULL will also cause this
	 * vma to be dumped unconditionally. */
	const char *(*name)(struct vm_area_struct *vma);

#ifdef CONFIG_NUMA
	/*
	 * set_policy() op must add a reference to any non-NULL @new mempolicy
	 * to hold the policy upon return.  Caller should pass NULL @new to
	 * remove a policy and fall back to surrounding context--i.e. do not
	 * install a MPOL_DEFAULT policy, nor the task or system default
	 * mempolicy.
	 */
	int (*set_policy)(struct vm_area_struct *vma, struct mempolicy *new);

	/*
	 * get_policy() op must add reference [mpol_get()] to any policy at
	 * (vma,addr) marked as MPOL_SHARED.  The shared policy infrastructure
	 * in mm/mempolicy.c will do this automatically.
	 * get_policy() must NOT add a ref if the policy at (vma,addr) is not
	 * marked as MPOL_SHARED. vma policies are protected by the mmap_sem.
	 * If no [shared/vma] mempolicy exists at the addr, get_policy() op
	 * must return NULL--i.e., do not &quot;fallback&quot; to task or system default
	 * policy.
	 */
	struct mempolicy *(*get_policy)(struct vm_area_struct *vma,
					unsigned long addr);
#endif
	/*
	 * Called by vm_normal_page() for special PTEs to find the
	 * page for @addr.  This is useful if the default behavior
	 * (using pte_page()) would not find the correct page.
	 */
	struct page *(*find_special_page)(struct vm_area_struct *vma,
					  unsigned long addr);
};
</code></pre>
<p>和我们的<code>mmap</code>有关的字段是</p>
<pre><code class="language-c">vm_fault_t (*fault)(struct vm_fault *vmf);
</code></pre>
<p>这个函数指针将在我们出现页错误的时候调用。</p>
<p>我们上面看到，<code>mmap</code>最终落实到了各个文件类型自己定义的<code>mmap</code>操作中。我们常见的EXT4文件系统中，这个操作为函数<code>ext4_file_mmap</code>:</p>
<pre><code class="language-c">static const struct vm_operations_struct ext4_file_vm_ops = {
	.fault		= ext4_filemap_fault,
	.map_pages	= filemap_map_pages,
	.page_mkwrite   = ext4_page_mkwrite,
};

static int ext4_file_mmap(struct file *file, struct vm_area_struct *vma)
{
	struct inode *inode = file-&gt;f_mapping-&gt;host;
	struct ext4_sb_info *sbi = EXT4_SB(inode-&gt;i_sb);
	struct dax_device *dax_dev = sbi-&gt;s_daxdev;

	if (unlikely(ext4_forced_shutdown(sbi)))
		return -EIO;

	/*
	 * We don't support synchronous mappings for non-DAX files and
	 * for DAX files if underneath dax_device is not synchronous.
	 */
	if (!daxdev_mapping_supported(vma, dax_dev))
		return -EOPNOTSUPP;

	file_accessed(file);
	if (IS_DAX(file_inode(file))) {
		vma-&gt;vm_ops = &amp;ext4_dax_vm_ops;
		vma-&gt;vm_flags |= VM_HUGEPAGE;
	} else {
		vma-&gt;vm_ops = &amp;ext4_file_vm_ops;
	}
	return 0;
}
</code></pre>
<p>可以看到，在通常情况下，是使用<code>ext4_filemap_fault</code>作为我们之前讲的<code>vm_operations_struct</code>中的<code>fault</code>字段。这个函数最终会被落实到<code>mm/filemap.c</code>的<code>filemap_fault</code>函数。在这个函数中，如果这个文件在内核的页缓存中，则直接去找那个页即可。如果没有，则调用<code>pagecache_get_page</code>，最终使用<code>__add_to_page_cache_locked</code>创建相应的页。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../src/filesystem/eventfd-eventfd2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../src/filesystem/eventfd-eventfd2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
